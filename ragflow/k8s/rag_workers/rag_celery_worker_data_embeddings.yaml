apiVersion: apps/v1
kind: Deployment
metadata:
  name: rag-worker-dataembeddings
  labels:
    k8s-app: rag-worker-dataembeddings
spec:
  replicas: 1
  selector:
    matchLabels:
      k8s-app: rag-worker-dataembeddings
  template:
    metadata:
      labels:
        k8s-app: rag-worker-dataembeddings
    spec:
      serviceAccountName: k8s-service-account
      containers:
      - name: cloud-sql-proxy
        image: gcr.io/cloud-sql-connectors/cloud-sql-proxy:latest
        args:
          - "--port=5432"
          - "sab-llm-hack-sbx-6315:us-central1:synxis-db"
          - "--private-ip"
        securityContext:
              # The default Cloud SQL proxy image runs as the
              # "nonroot" user and group (uid: 65532) by default.
              runAsNonRoot: true
      - name: worker-data-embeddings
        image: us-central1-docker.pkg.dev/sab-llm-hack-sbx-6315/gcf-artifacts/ragpipeline:v1
        imagePullPolicy: Always
        env:
        - name: REDIS_SERVER
          value: "celery-redis:6379/0"
        - name: PDF_BATCH_SIZE
          value: "25"
        - name: GCS_BUCKET
          value: "synxis-src"
        - name: VECTOR_HOST
          value: "127.0.0.1"
        - name: VECTOR_PORT
          value: "5432"
        - name: VECTOR_USER
          valueFrom:
            secretKeyRef:
              name: pgvector-store-secrets
              key: VECTOR_USER
        - name: VECTOR_PWD
          valueFrom:
            secretKeyRef:
              name: pgvector-store-secrets
              key: VECTOR_PWD
        - name: VECTOR_DB
          valueFrom:
            secretKeyRef:
              name: pgvector-store-secrets
              key: VECTOR_DB
        - name: VECTOR_COLLECTIONS
          value: "sabre_vector_synxis"
        - name: NFS_MOUNT
          value: "/sharedvol1"
        volumeMounts:
          - name: fileserver
            mountPath: /sharedvol1 # the shared directory
        command: ["celery"]
        args: ["-A", "tasks", "worker","--pool=solo","--concurrency=1","--queues=data_embed_ingest","--loglevel=debug" ,"-E"]
        resources:
          limits:
            cpu: 1.0
            memory: 2048Mi
          requests:
            cpu: 0.5
            memory: 2048Mi
      volumes:
        - name: fileserver
          persistentVolumeClaim:
            claimName: fileserver1
